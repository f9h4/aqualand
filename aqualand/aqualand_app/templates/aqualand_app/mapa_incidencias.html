{% extends 'aqualand_app/base.html' %}

{% block title %}Mapa de Incidencias - {{ block.super }}{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h2>Mapa de Incidencias</h2>
    </div>
</div>

<div class="row">
    <div class="col-md-9">
        <div class="card">
            <div class="card-body">
                <div id="map" style="height: 700px;"></div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Filtros</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Tipo de Incidencia</label>
                    <div id="tipo-filtros">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="CORTE" id="tipo-corte" checked>
                            <label class="form-check-label" for="tipo-corte">
                                Corte de Agua
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="FUGA" id="tipo-fuga" checked>
                            <label class="form-check-label" for="tipo-fuga">
                                Fuga de Agua
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="CALIDAD" id="tipo-calidad" checked>
                            <label class="form-check-label" for="tipo-calidad">
                                Problema de Calidad
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="OTROS" id="tipo-otros" checked>
                            <label class="form-check-label" for="tipo-otros">
                                Otros Problemas
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Estado</label>
                    <div id="estado-filtros">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="REPORTADO" id="estado-reportado" checked>
                            <label class="form-check-label" for="estado-reportado">
                                Reportado
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="EN_PROCESO" id="estado-proceso" checked>
                            <label class="form-check-label" for="estado-proceso">
                                En Proceso
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="RESUELTO" id="estado-resuelto" checked>
                            <label class="form-check-label" for="estado-resuelto">
                                Resuelto
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Estadísticas</h5>
            </div>
            <div class="card-body">
                <p style="margin: 10px 0;"><strong>Total en filtros:</strong> <span id="total-incidencias" style="color: #007bff; font-weight: bold;">0</span></p>
                <hr>
                <p style="margin: 5px 0; font-size: 12px;"><span style="color: #dc3545;">●</span> <strong>Corte:</strong> <span id="count-corte">0</span></p>
                <p style="margin: 5px 0; font-size: 12px;"><span style="color: #0099ff;">●</span> <strong>Fuga:</strong> <span id="count-fuga">0</span></p>
                <p style="margin: 5px 0; font-size: 12px;"><span style="color: #ff9800;">●</span> <strong>Calidad:</strong> <span id="count-calidad">0</span></p>
                <p style="margin: 5px 0; font-size: 12px;"><span style="color: #9c27b0;">●</span> <strong>Otros:</strong> <span id="count-otros">0</span></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    // Inicializar el mapa
    var map = L.map('map').setView([-33.4489, -70.6693], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Crear un grupo de marcadores con clustering
    var markers = L.markerClusterGroup();
    var allMarkers = [];

    // Función para actualizar los contadores de estadísticas
    function updateStats(incidencias) {
        const total = incidencias.length;
        const cortes = incidencias.filter(i => i.tipo === 'CORTE').length;
        const fugas = incidencias.filter(i => i.tipo === 'FUGA').length;
        const calidad = incidencias.filter(i => i.tipo === 'CALIDAD').length;
        const otros = incidencias.filter(i => i.tipo === 'OTROS').length;

        document.getElementById('total-incidencias').textContent = total;
        document.getElementById('count-corte').textContent = cortes;
        document.getElementById('count-fuga').textContent = fugas;
        document.getElementById('count-calidad').textContent = calidad;
        document.getElementById('count-otros').textContent = otros;
    }

    // Función para obtener los filtros seleccionados
    function getSelectedFilters() {
        const tipoFiltros = Array.from(document.querySelectorAll('#tipo-filtros input:checked')).map(cb => cb.value);
        const estadoFiltros = Array.from(document.querySelectorAll('#estado-filtros input:checked')).map(cb => cb.value);
        return { tipos: tipoFiltros, estados: estadoFiltros };
    }

    // Función para actualizar los marcadores según los filtros
    function updateMarkers() {
        const filtros = getSelectedFilters();
        markers.clearLayers();
        
        const filteredMarkers = allMarkers.filter(marker => {
            const incidencia = marker.incidencia;
            return filtros.tipos.includes(incidencia.tipo) && filtros.estados.includes(incidencia.estado);
        });

        filteredMarkers.forEach(marker => markers.addLayer(marker));
        updateStats(filteredMarkers.map(m => m.incidencia));
    }

    // Ubicación predeterminada (centro de Chile)
    const defaultLat = -33.4489;
    const defaultLng = -70.6693;

    // Cargar las incidencias desde la API
    fetch('/api/incidencias/')
        .then(response => response.json())
        .then(data => {
            data.forEach(incidencia => {
                // Si tiene coordenadas, usar esas
                if (incidencia.ubicacion_lat && incidencia.ubicacion_lng) {
                    addMarkerToMap(incidencia, incidencia.ubicacion_lat, incidencia.ubicacion_lng);
                } 
                // Si no tiene coordenadas pero tiene dirección, geocodificar
                else if (incidencia.direccion) {
                    geocodeAddress(incidencia);
                }
                // Si no tiene ni coordenadas ni dirección, usar ubicación predeterminada
                else {
                    addMarkerToMap(incidencia, defaultLat, defaultLng);
                }
            });
            
            updateMarkers();
            map.addLayer(markers);
        });

    // Función para geocodificar una dirección usando Nominatim
    function geocodeAddress(incidencia) {
        const address = incidencia.direccion;
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
        
        fetch(url)
            .then(response => response.json())
            .then(results => {
                if (results.length > 0) {
                    const result = results[0];
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);
                    addMarkerToMap(incidencia, lat, lng);
                    updateMarkers();
                } else {
                    // Si no se encuentran resultados, usar ubicación predeterminada
                    addMarkerToMap(incidencia, defaultLat, defaultLng);
                    updateMarkers();
                }
            })
            .catch(error => {
                console.log('Error geocodificando:', error);
                // Si hay error, usar ubicación predeterminada
                addMarkerToMap(incidencia, defaultLat, defaultLng);
                updateMarkers();
            });
    }

    // Función para obtener color según tipo de incidencia
    function getMarkerColor(tipo) {
        const colors = {
            'CORTE': '#dc3545',      // Rojo
            'FUGA': '#0099ff',       // Azul
            'CALIDAD': '#ff9800',    // Naranja
            'OTROS': '#9c27b0'       // Púrpura
        };
        return colors[tipo] || '#808080';
    }

    // Función para crear un icono personalizado
    function createCustomMarker(tipo) {
        const color = getMarkerColor(tipo);
        return L.icon({
            iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 41" width="32" height="41">
                    <path fill="${color}" d="M16 0C7.2 0 0 7.2 0 16c0 8.8 16 25 16 25s16-16.2 16-25c0-8.8-7.2-16-16-16z"/>
                    <circle cx="16" cy="16" r="6" fill="white"/>
                </svg>
            `),
            iconSize: [32, 41],
            iconAnchor: [16, 41],
            popupAnchor: [0, -41]
        });
    }

    // Función para agregar un marcador al mapa
    function addMarkerToMap(incidencia, lat, lng) {
        const marker = L.marker([lat, lng], {
            icon: createCustomMarker(incidencia.tipo)
        });
        marker.incidencia = incidencia;
        
        const fechaReporte = new Date(incidencia.fecha_reporte).toLocaleDateString('es-CL');
        const estadoColor = incidencia.estado === 'RESUELTO' ? '#28a745' : 
                           incidencia.estado === 'EN_PROCESO' ? '#ffc107' : '#dc3545';
        
        const popupContent = `
            <div style="min-width: 250px; font-size: 14px;">
                <h6 style="margin-bottom: 10px; color: #333;">${incidencia.titulo}</h6>
                <hr style="margin: 8px 0;">
                <p style="margin: 5px 0;"><strong>Tipo:</strong> <span style="color: ${getMarkerColor(incidencia.tipo)}; font-weight: bold;">${incidencia.tipo_display}</span></p>
                <p style="margin: 5px 0;"><strong>Estado:</strong> <span style="color: ${estadoColor}; font-weight: bold;">${incidencia.estado_display}</span></p>
                <p style="margin: 5px 0;"><strong>Región:</strong> ${incidencia.region_nombre}</p>
                <p style="margin: 5px 0;"><strong>Fecha:</strong> ${fechaReporte}</p>
                ${incidencia.direccion ? `<p style="margin: 5px 0;"><strong>Dirección:</strong> ${incidencia.direccion}</p>` : '<p style="margin: 5px 0; font-style: italic; color: #999;">Sin dirección especificada</p>'}
                <hr style="margin: 8px 0;">
                <a href="/incidencias/${incidencia.id}/" class="btn btn-sm btn-primary" style="width: 100%;">Ver Detalles</a>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        allMarkers.push(marker);
    }

    // Eventos para los filtros
    document.querySelectorAll('#tipo-filtros input, #estado-filtros input').forEach(checkbox => {
        checkbox.addEventListener('change', updateMarkers);
    });
</script>
{% endblock %}